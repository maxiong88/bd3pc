var commonJs = {
    curPage: 1,
    loading1 : function(flag){
        if(!!flag){
            $('html, body').addClass('overflow-class')
            return '<div class="mask-loading1"><div class="mask-loading1-spinner"><div class="mask-loading1-box__content"><span></span><span></span><span></span><span></span><span></span></div><p class="mask-loading1-text">拼命加载中</p></div></div>';
        }else{
            $('html, body').removeClass('overflow-class')
            $('mask-loading1').remove();
        }
    },
    render: function(tpl, domtpl, data){
        console.log(tpl, domtpl, data)
        var getTpl = document.getElementById(tpl).innerHTML
            ,view = document.querySelector(domtpl);
        laytpl(getTpl).render(data, function(html){
            view.innerHTML = html;
            });
    },
    mCustomScrollbar: function(el, a){
        $(el).mCustomScrollbar({
            theme:"minimal-dark",
            axis:"x",
            setLeft: !!a ? '' : '-60px',
        });
    },
    _doAjax : function(n, t, e){
        return $.ajax({
            type: 'get',
            url : n,
            data : t,
            dataType : "json",
            success : function(n){
                e && e(n)
            }
        })
    },
    ajaxError : function(n){
        alert(n.msg)
    },
    article_list_init:function(url, data, page, pageSize, el){
        var that = this;
        that.c(); 
        data.page = page;
        data.pageSize = pageSize;
        console.log(document.querySelector(el))
        document.querySelector(el) && that.getData(url, data, el)
        $("body").on('click', '.m-pagination  a', function(){  
            var rel = $(this).attr("rel");  
            if(rel){  
                data.page = rel;
                that.getData(url, data, el);  
            }  
        });	     
    },
    article_init:function(){
        var that = this;
        that.c();
        var body = $('body');
        var offsetRight = $('.w1024').length>0 && $('.w1024').offset().left;
        var offsetRightDom = offsetRight<102 ? 0 : offsetRight-108;
        // $('.art-nav-fixed').css({"left" : offsetRightDom+"px"})
        offsetRight < 102 ? $('.art-nav-fixed').remove() : ''; 
        window.onscroll=function(e){
            scrollTopA()
        }

        scrollTopA()
        function scrollTopA(){
            var sTop = document.documentElement.scrollTop || document.body.scrollTop;
            if(sTop > 398){
                $('.art-nav-fixed').css({
                    "position":"fixed",
                    "left":offsetRightDom+"px",
                    "top":"30px",
                })
            }else{
                $('.art-nav-fixed').css({
                    "position":"absolute",
                    "left":"-106px",
                    "top":"0",
                })
            }
        }
    },
    c: function(){
        var offsetRight = $('.w1024').length>0 && $('.w1024').offset().left;
        var offsetRightDom = offsetRight<72 ? 0 : offsetRight- 66;
        var commonStyle = '';
            commonStyle = 'right:'+offsetRightDom+'px';
        var commonHTML = '';
            commonHTML += '<div class="common-box-0" style="'+commonStyle+'">';
            commonHTML += '<a href="javascript:;" id="topNav" class="item-top" title="返回顶部"></a>';
            commonHTML += '<a href="/web/default/index" id="homeNav" class="item-home" title="返回主页"></a>';
            commonHTML += '</div>';
        var body = $('body');
            offsetRight < 48 ? $('.common-box-0').remove() : body.append(commonHTML);
            $('body').on('click', '#topNav', function(){
                $("html,body").animate({scrollTop:0},500);
            })
    },
    stig_init:function(url,ell, ell2, el){
        var that = this;
        el && that.mCustomScrollbar(el)
        that.c();
        $('#_js_stig_input').keyup(function(event){
            if(event.keyCode ==13){
                var obj = {};
                obj.name = $.trim($(this).val());
				if($.trim($(this).val())){
					$.ajax({
						url: url,
						type: 'get',
						dataType: 'json',
						data: obj,
						success: function(data){
							if(data.status === 1){
								if(data.data.length !== 0){
								$(ell2).hide();
								$(ell).show();
								$(ell).addClass('item-0');
								that.render('tpl', ell, data.data);									
								}else{
									alert('没有搜到，请输出正确的圣痕名称')
								}						
							}else{
								alert('没有搜到，请输出正确的圣痕名称')
							}
						}
					})					
				}else{
					$(ell2).show();
					$(ell).hide();
				}

            }
        });
    },
    stig_details_init: function(url, data, page, pageSize, posid, el){
        var that = this;
        $('body').append('<div id="tooltip0603"><div class="bd-tooltip">在所有同位圣痕中排在第<span></span>位</div></div>')
        $('.stig-table-2 em').each(function(){
            if($(this).text() == 0){
                $(this).hide();
            }else{
                $(this).html('#'+$(this).text())
            }
        });
        $('.stig-table-2 em').mouseover(function(){
            console.log($(this)[0].getBoundingClientRect().top + (document.documentElement.scrollTop || document.body.scrollTop))
            var 
           // var left = $(this)[0].getBoundingClientRect().right-70;
           // var top = $(this)[0].getBoundingClientRect().top-70;
            //$('#tooltip0603 span').html($(this).text().slice(1))
           $('#tooltip0603 .bd-tooltip').css({"right":0, "top": $(this)[0].getBoundingClientRect().top + (document.documentElement.scrollTop || document.body.scrollTop)}).show();
            // console.log($(this)[0].getBoundingClientRect(),$(this)[0].clientTop, $(this)[0].clientLeft)
        }).mouseout(function(){
            // $('#tooltip0603').hide();
        })
        data.page = page;
        data.pageSize = pageSize;
        // data.type = 1;
        data.posid = posid;
        data.pos_entity_id = that.getQueryVariable('id');
        document.querySelector(el) && that.getData(url, data, el)
        $("body").on('click', '.m-pagination  a', function(){  
            var rel = $(this).attr("rel");  
            if(rel){  
                data.page = rel;
                that.getData(url, data, el);  
            }  
        });	
	},
    valk_details_init: function(url, data, page, pageSize, posid, el){
	    var that = this;
        data.page = page;
        data.pageSize = pageSize;
        data.type = 1;
        data.posid = posid;
        data.pos_entity_id = that.getQueryVariable('id');
        document.querySelector(el) && that.getData(url, data, el)
        $("body").on('click', '.m-pagination  a', function(){  
            var rel = $(this).attr("rel");  
            if(rel){  
                data.page = rel;
                that.getData(url, data, el);  
            }  
        });	
	},
    valk_init: function(el, a, url, data, page, pageSize, ell){
        var that = this;
        that.c();
		data.page = page;
        data.pageSize = pageSize;
		console.log(ell, el)
        document.querySelector(ell) && that.getData(url, data, ell, function(){
			that.mCustomScrollbar(el, a)
		})
        $("body").on('click', '.m-pagination  a', function(){  
            var rel = $(this).attr("rel");  
            if(rel){  
                data.page = rel;
                that.getData(url, data, ell, function(){
			that.mCustomScrollbar(el, a)
		});  
            }  
        });	
        
    },
    arms_details_init: function(url, data, page, pageSize, posid, el){  
        var that = this;
        data.page = page;
        data.pageSize = pageSize;
        data.type = 1;
        data.posid = posid;
        data.pos_entity_id = that.getQueryVariable('id');
        document.querySelector(el) && that.getData(url, data, el)
        $('.arms-detals-tab a').on('click', function(){
            $(this).addClass('on').siblings().removeClass('on');
            var _eq = $(this).index();
            $('.arms-details-tab-box .tab-box').hide().eq(_eq).show();
        });
        $("body").on('click', '.m-pagination  a', function(){  
            var rel = $(this).attr("rel");  
            if(rel){  
                data.page = rel;
                that.getData(url, data, el);  
            }  
        });
        that.c();
    },
    arms_init: function(url, data, page, pageSize, el){ 
        var that = this;
        data.page = page;
        data.pageSize = pageSize;
        that.getData(url, data, el); 
        $('.arms-tab-list a').on('click', function(){
            $(this).addClass('on').siblings().removeClass('on');
            var type = $(this).data('type');
            data.type = type;
            data.page = 1;
            that.getData(url, data, el); 
        });
        $('.weapon_search_ipt').keyup(function(event){
            if(event.keyCode == 13){
                $('.arms-tab-list a').removeClass('on');
                data.page = 1;
                data.searchKey = $(this).val();
                that.getData(url, data, el, '', 'armsinitS'); 
            }
        });
        $("body").on('click', '.m-pagination  a', function(){  
            var rel = $(this).attr("rel");  
            if(rel){  
                data.page = rel;
                that.getData(url, data, el);  
            }  
        });
        
        this.c();
    },
    home: function(el){
        this.mCustomScrollbar(el)
        this.c()
    },
    // 我的舰团推荐
    init_fleet:function(url){
        var that = this;
        var type; // 战舰招募 type
        // 初始值
        !!$('#_js_img').attr('src') ? $('.upload-box-item0').hide() : $('.upload-box-item0').show();
        // 点击图片上传
        $('#_js_file_upload').change(function(e){
            var file = e.target.files && e.target.files[0];
            if (!(/^image\/.*$/i.test(file.type))) {
                alert('请上传正确格式图片');
                return; //不是图片 就跳出这一次循环  
            }  
            //实例化FileReader API  
            var freader = new FileReader();  
            freader.readAsDataURL(file);  
            freader.onload = function(e) {
                if(!$('.upload-box-item0').is(':hidden')){
                    $('.upload-box-item0').hide()
                }
                $('#_js_img').attr('src',e.target.result);  
            } 
        })
        // 用户点击区服
        $('.modal-district').on('click', 'li', function(){
            var districtVal = $(this).data('district');
            var districtValF = districtVal.split(",")[1];
            $('#_js_district').attr('data-district-msg', districtVal).find('span').html(districtValF);
            $('.modal-district').hide();
        });
        $('#_js_district').hover(function(){
            $('.modal-district').show();
        },function(){
            $('.modal-district').hide();
        })
        // 用户预览
        $('#_js_preview').on('click', function(){
            var _data = that.fleetCmDistrict();
            var iframeElement = $("#_js_iframe");  
            console.log(_data)                    
            try{
                if(_data){
                    var sessionStorageiframeHtml = sessionStorage.setItem('sessionStorageiframeHtml', JSON.stringify(that.fleetCmDistrict()));
                var iframeDoc = iframeElement.contents().find('html').html();
                var codeWin = window.open();
                    codeWin.document.write(iframeDoc);
                    codeWin.document.close();
                    console.log(sessionStorageiframeHtml, iframeDoc, codeWin)
                }
            }catch(err){
                console.log(err)
                alert('换chrome浏览器吧')
            }
        });
        // 用户提交
        function calculateLayout(){
            var _data = that.fleetCmDistrict();
            if(true){
                $('body,html').css('overflow','hidden');
                $('body').append(that.loading1(true));
                that._doAjax(url,_data, function(req){
                    if(req.code === 1){
                        $('.mask-loading').find('.mask-loading-box__content').html('提交成功');
                        $('.mask-loading').find('.mask-loading-box__btns').show();
                        $('body').append(that.loading1());
                        $('body').on('click', '.mask-loading-box__btns a', function(){
                            window.location.href = "./fleet-list.html"
                        })  
                    }else{
                        $('body').append(that.loading1());
                        alert(req.msg)
                    }
                })
            }
        }
        $('#_js_release').on('click', _.debounce(calculateLayout, 3000,{leading:true}));
        that.c();
    },
    /*舰团js*/
    fleetCmDistrict : function(){
        var pattern = new RegExp("[~'!@#$%^&*()-+_=:]");
        var headline = $.trim($('#headline').val());
        var districtS = $('#_js_district').data('district-msg').split(',')[1];
        var shipName = $.trim($('#shipName').val());
        var shipId = $.trim($('#shipId').val());
        var qqId = $.trim($('#qqId').val());
        var detMsg = $.trim($('#detMsg').val());
        var imgPic = $('#_js_img').attr('src');
        if(!!headline){
            if(pattern.test(headline)){
                alert('标题非法输入');
                return
            }
        }else{
            alert('创建标题不能为空');
            return
        }
        if(!!shipName){
            if(pattern.test(shipName)){
                alert('舰团名称非法输入');
                return
            }
        }else{
            alert('舰团名称不能为空');
            return                                
        }
        if(!!shipId){
            if(pattern.test(shipId)){
                alert('舰团ID非法输入');
                return
            }
            if(!shipId.match(/[0-9]{4,}/g)){
                alert('舰团ID非法输入');
                return  
            }
        }else{
            alert('舰团ID不能为空');
            return 
        }
        if(!!qqId){
            if(pattern.test(qqId)){
                alert('QQ群号非法输入');
                return
            }
            if(!qqId.match(/[0-9]{4,}/g)){
                alert('QQ群号非法输入');
                return  
            }
        }else{
            alert('QQ群号不能为空');
            return 
        }
        if(!!detMsg){
            if(pattern.test(detMsg)){
                alert('详情内容非法输入');
                return
            }
        }else{
            alert('详情内容不能为空');
            return 
        }
        return {
            username : '我就不告诉你', // 用户名
            portrait : '../img/yuanliang@1x.png', // 头像 需要后端返回
            temporary : Date.now(),
            headline : headline,
            districtS : districtS,
            shipName : shipName,
            shipId : shipId,
            qqId : qqId,
            detMsg : detMsg,
            imgPic : imgPic,
        }
    },

    init_fleet_list : function(url, page, pageSize, el){
        // 舰团列表页
        var that = this;
        var fleetListType = $('.MD-fleet-list-sel a.item-0');
        var type;
        type = $('.MD-fleet-list-sel a.item-0.on').data('type');
        var data = {
            page : page,
            pageSize : pageSize,
            type : type,   
        }
        fleetListType.on('click', function(){
            fleetListType.removeClass('on');
            $(this).addClass('on');
            type = $(this).data('type');
            var data = {
                page : 1,
                pageSize : pageSize,
                type : type,
            }
            that.getData(url, data, el)
        });
        $("body").on('click', '.m-pagination  a', function(){  
            var rel = $(this).attr("rel");  
            if(rel){  
                data.page = rel;
                that.getData(url, data, el);  
            }  
        });
        that.getData(url, data, el);
        that.c();
    },
    team_recommen:function(url, page, pageSize,el){
        var that = this;
        var data  ={};
        $('.team-recommen-tab').on('click', '.item-0 dt', function(){
            $('.team-recommen-tab .item-0').removeClass('on');
            $(this).parent().addClass('on');
            data.page = 1;
            data.pageSize = pageSize;
            data.typeTabA =  $(this).parent().find('.item-00').find('dd').eq(0).data('p');
            data.typeTabB = $(this).data('t');
            that.getData(url, data, el); 
        });
        $('.team-recommen-tab .item-0').on('click', '.item-00 dd', function(){
            //console.log($(this).data('p'), $(this).parents('.item-0').find('dt').data('t'))
            data.typeTabA = $(this).data('p');
            data.page = 1;
            data.pageSize = pageSize;
            data.typeTabB = $(this).parents('.item-0').find('dt').data('t');
            that.getData(url, data, el); 
        });
        data.page = page;
        data.pageSize = pageSize;
        data.typeTabA = $('.team-recommen-tab .item-0.on').find('dt').data('t');
        data.typeTabB = $('.team-recommen-tab .item-0.on').find('dl dd').eq(0).data('p');
        that.getData(url, data, el); 
        $("body").on('click', '.m-pagination  a', function(){  
            var rel = $(this).attr("rel");  
            if(rel){  
                data.page = rel;
                that.getData(url, data, el); 
            }  
        });
        that.c();
    },
    //获取数据  
    getData(url, data, el, cb, typ){
		var pagebool = 0;
        var that = this;
        $.ajax({  
            type: 'get',  
            url: url,  
            data: data,  
            dataType:'json',  
            beforeSend:function(){  
                $(el).parent().find(".loading").show();  
            },  
            success:function(json){  
                $(el).parent().find(".loading").hide();  
                $(el).empty();
                
                that.total = json.total; //总记录数
                if(!that.total){
                    $('.m-pagination').html('');
                    if(typ === 'armsinitS'){
                        return alert('没有搜到，请输出正确的武器名称')
                    }
                }
                
                //that.pageSize = json.pageSize; //每页显示条数  
                that.curPage = json.page; //当前页  
                that.totalPage = json.totalPage; //总页数
                that.render('tpl', el, json.data);
				pagebool = json.page;
            },  
            complete:function(){ //生成分页条  
				if(pagebool>0){
					that.getPageBar(el);  
					cb && cb()	
				}
            },  
            error:function(){  
                alert("数据加载失败");  
            }  
        });  
    },
    //获取分页条  
    getPageBar(el){
        var that = this; 
        //页码大于最大页数  
        if(that.curPage>that.totalPage) that.curPage=that.totalPage;  
        //页码小于1  
        if(that.curPage<1) that.curPage=1;  
        pageStr = "<span class='count'>共"+that.total+"条"+that.curPage+"/"+that.totalPage+"</span>";  
        
        //如果是第一页  
        if(that.totalPage<=4)  
        {  
            if(that.curPage==1){  
                pageStr += "<span class='cur'>1</span>";  
                for(var i=2;i<=that.totalPage;i++)  
                {  
                    pageStr += "<a href='javascript:void(0)' class='pi' rel='"+i+"'>"+i+"</a>";  
                }  
            }else{  
                pageStr += "<a href='javascript:void(0)' class='pi' rel='1'>首页</a><a href='javascript:void(0)' class='pi' rel='"+(that.curPage-1)+"'>上一页</a>";  
                for(var i=1;i<=that.totalPage;i++)  
                {  
                    if(i==that.curPage)  
                    {  
                        pageStr += "<span class='cur'>"+i+"</span>"  
                    }  
                    else  
                    {  
                        pageStr += "<a href='javascript:void(0)' class='pi' rel='"+i+"'>"+i+"</a>";  
                    }  
                }  
                
            }  
        }  
        else//当页数大于5的时候就要这样显示1 2 3 4 ...  
        {  
            if(that.curPage<=3){  
                if(that.curPage==1)  
                {  
                    pageStr += "<span class='cur'>1</span>";  
                }  
                else  
                {  
                    pageStr += "<a href='javascript:void(0)' class='pi' rel='1'>首页</a><a href='javascript:void(0)' class='pi' rel='"+(that.curPage-1)+"'>上一页</a>";  
                    pageStr += "<a href='javascript:void(0)' class='pi' rel='1'>1</a>";  
                }  
                for(var i=2;i<=4;i++)  
                {  
                    if(i==that.curPage)  
                    {  
                        pageStr += "<span class='cur'>"+i+"</span>"  
                    }  
                    else  
                    {  
                        pageStr += "<a class='pi' href='javascript:void(0)' rel='"+i+"'>"+i+"</a>";  
                    }  
                }  
                pageStr += "<span class='cur1'>...</span>";  
            }else{  
                pageStr += "<a href='javascript:void(0)' class='pi' rel='1'>首页</a><a href='javascript:void(0)' class='pi' rel='"+(that.curPage-1)+"'>上一页</a>";  
                pageStr += "<span class='cur1'>...</span>";  
                if(that.curPage>that.totalPage-2)  
                {  
                    for(var i=that.totalPage-2;i<=that.totalPage;i++)  
                    {  
                        if(i==that.curPage)  
                        {  
                            pageStr += "<span class='cur'>"+i+"</span>"  
                        }  
                        else  
                        {  
                            pageStr += "<a class='pi' href='javascript:void(0)' rel='"+i+"'>"+i+"</a>";  
                        }  
                    }  
                }  
                else  
                {  
                    pageStr += "<a class='pi' href='javascript:void(0)' rel='"+(that.curPage-1)+"'>"+(that.curPage-1)+"</a>";  
                    pageStr += "<span class='cur'>"+that.curPage+"</span>";  
                    pageStr += "<a class='pi' href='javascript:void(0)' rel='"+(parseInt(that.curPage)+1)+"'>"+(parseInt(that.curPage)+1)+"</a>";  
                    pageStr += "<span class='cur1'>...</span>";  
                }  
            }  
        }  
        //如果是最后页  
        if(that.curPage>=that.totalPage){  
            pageStr += "<span>下一页</span>   <span>最后一页</span>";  
        }else{  
            pageStr += "<a href='javascript:void(0)' class='pi' rel='"+(parseInt(that.curPage)+1)+"'>下一页</a><a href='javascript:void(0)' class='pi' rel='"+that.totalPage+"'>最后一页</a>";  
        }  
            
        $(el).parent().find(".m-pagination").html(pageStr);
    },
    personalFn:function(){
        var that = this;
        that.c();
        $('.itemA').on('click', '.itemDel', function(){
            var that = $(this);
            that.hide().parent().find('.itemDelBox').show();
        });
        $('.itemA').on('click', '.itemDelA', function(){
            var that = $(this);
            // ajax 成功以后  可以删除我的舰队招募 获取 id
            /*
                $.ajax({
                    url: '',
                    type:'post',
                    data:{id:$(this).data('id')},
                    dataType:'json',
                    success:function(){}
                })
            */
            that.parents('li').remove();
        });
        $('.itemA').on('click', '.itemDelB', function(){
            var that = $(this);
            that.parents('li').find('.itemDel').show();
            that.parent().hide();
        });
        $('.personalCenterBox .itemA').on('click', '.item-3', function(){
            var that = $(this);
            that.addClass('close');
            that.parents('.itemA').find('.itemB').show();
        })
    },
    getQueryVariable:function(variable){
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] == variable){return pair[1];}
        }
        return(0);
    }
}
